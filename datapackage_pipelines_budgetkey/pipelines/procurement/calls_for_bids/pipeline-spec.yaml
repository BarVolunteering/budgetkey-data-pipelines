calls-for-bids:
  schedule:
    crontab: "0 16 * * *"

  pipeline:
    - run: add_metadata
      parameters:
        name: calls-for-bids
    - flow: molsa
      runner: tzabar
    - run: sample
    - run: concatenate
      parameters:
        fields:
          publication_id: []
          tender_type: []
          page_title: []
          publisher: []
          publishing_unit: []
          ordering_units: []

          start_date: []
          claim_date: []

          decision: []
          reason: []
          description: []

          contact: []
          conatct_email: []

          target_audience: []
          required_documents: []
          partners: []

          documents: []
        target:
          name: calls_for_bids
          path: calls_for_bids.csv
    - run: set_types
      parameters:
        types:
          publication_id:
            type: integer
          ordering_units:
            type: array
            es:itemType: string

          start_date:
            type: date
            format: '%d/%m/%Y'
          claim_date:
            type: date
            format: '%d/%m/%Y'

          required_documents:
            type: array
            es:itemType: string

          documents:
            type: array
            es:itemType: object
            es:schema:
              fields:
                - {name: link, type: string}
                - {name: description, type: string}
                - {name: update_time, type: string}


    - run: set_primary_key
      parameters:
        calls_for_bids:
          - publication_id
    - run: dump_to_path
      parameters:
        out-path: /var/datapackages/procurement/calls_for_bids
    - run: dump_to_sql
      parameters:
        tables:
          calls_for_bids:
            resource-name: calls_for_bids
            mode: update

calls-for-bids-all:
  dependencies:
    - pipeline: procurement/calls_for_bids/calls-for-bids

  pipeline:
    - run: add_sql_resource
      parameters:
        datapackage: /var/datapackages/procurement/calls_for_bids/datapackage.json
        resource: calls_for_bids
        table: calls_for_bids
    - run: stream_remote_resources
    - run: dump_to_path
      parameters:
        out-path: /var/datapackages/procurement/calls_for_bids_all

